# Политика безопасности

**Версия:** 1.0  
**Дата:** 2025-11-09

---

## JWT и токены

### JWT библиотеки

**Единственная библиотека:** `jose`
- Запрещены другие JWT библиотеки (`jsonwebtoken`, `@tsndr/cloudflare-worker-jwt`)
- Проверка в CI: запрет других JWT пакетов

### Ротация JWT секретов

**Период:** Каждые 90 дней

**Процесс:**
1. Сгенерировать новый секрет: `openssl rand -base64 32`
2. Добавить в staging, протестировать
3. Добавить в production
4. Grace period 7 дней
5. Удалить старый секрет

### Service-to-Service авторизация

**Механизм:** Service JWT через `SERVICE_JWT_SECRET`

**Правила:**
- Один секрет для всех сервисов
- JWT содержит `service` claim
- Проверка на каждом межсервисном запросе

---

## Rate Limiting

### Стратегия

**На уровне API Gateway:**
- Публичные GET: 100 req/min per IP
- Приватные GET: 200 req/min per User ID
- POST endpoints: индивидуальные лимиты (см. `docs/ops/RATE_LIMIT_RULES.md`)

**На уровне сервисов:**
- Velocity limits для Points/Referral
- Anti-abuse эвристики

См. `docs/ops/RATE_LIMIT_RULES.md` для деталей.

---

## CORS

### Разрешённые origins

**Production:**
- `https://go2asia.space`
- `https://www.go2asia.space`

**Staging:**
- `https://staging.go2asia.space`

**Development:**
- `http://localhost:3000`
- `http://localhost:5173`

**Preview deployments:**
- `https://*.netlify.app` (Netlify previews)

### Настройка

```typescript
// API Gateway
app.use('*', cors({
  origin: [
    'https://go2asia.space',
    'https://*.netlify.app',
    'http://localhost:3000',
  ],
  credentials: true,
}));
```

---

## Clerk Webhook Verification

### Обязательная проверка

Все webhook запросы от Clerk должны проверяться:

```typescript
import { verifyWebhookSignature } from '@clerk/clerk-sdk-node';

const isValid = verifyWebhookSignature(
  body,
  headers,
  CLERK_WEBHOOK_SECRET
);

if (!isValid) {
  return c.json({ error: 'Invalid signature' }, 401);
}
```

### Секрет

- Хранится в Cloudflare Secrets: `CLERK_WEBHOOK_SECRET`
- Получается из Clerk Dashboard → Webhooks → Signing Secret
- Ротируется при компрометации

---

## Secrets и ключи

### Правила хранения

1. **Никогда не коммитить секреты в Git**
   - Использовать `.env.example` без реальных значений
   - Добавить `.env` в `.gitignore`

2. **Использовать разные секреты для разных окружений**
   - Production и Staging должны иметь разные секреты

3. **Ограничить доступ**
   - Только необходимые люди имеют доступ
   - Принцип наименьших привилегий

### Ротация секретов

См. `docs/ops/ENV_VARS.md` → раздел "Ротация секретов"

---

## Anti-Abuse правила

### Points начисление

- Velocity limits: максимум 1000 поинтов в час
- Sanity checks: максимум 100 поинтов за одно действие
- Проверка на автоматизацию: минимум 1 секунда между запросами

### Referral регистрация

- Velocity limits: максимум 5 регистраций по одному коду в час
- IP проверка: максимум 3 регистрации с одного IP в 24 часа
- CAPTCHA при подозрительной активности

См. `docs/ops/RATE_LIMIT_RULES.md` для деталей.

---

## Обработка инцидентов безопасности

### Процесс

1. **Обнаружение инцидента**
   - Мониторинг алертов
   - Отчёты пользователей
   - Аудит логов

2. **Оценка критичности**
   - P0: Компрометация данных, утечка секретов
   - P1: Подозрительная активность, попытки атак
   - P2: Мелкие нарушения

3. **Действия**

   **P0 (критично):**
   - Немедленно заблокировать доступ
   - Ротировать все секреты
   - Уведомить команду
   - Начать расследование

   **P1 (высокий приоритет):**
   - Заблокировать подозрительные IP/User ID
   - Усилить мониторинг
   - Проанализировать логи

   **P2 (низкий приоритет):**
   - Задокументировать
   - Добавить в backlog для исправления

4. **Постмортем**
   - Анализ инцидента
   - Документирование
   - План предотвращения

---

## Аудит и логирование

### Что логировать

- Все действия с секретами (ротация, доступ)
- Все подозрительные запросы (rate limit exceeded, invalid JWT)
- Все ошибки авторизации
- Все изменения критичных данных (Points, Referral)

### Хранение логов

- Минимум 90 дней для обычных логов
- Минимум 1 год для audit-логов
- Соответствие GDPR (право на удаление)

---

## Соответствие требованиям

### GDPR

- Право на удаление данных
- Право на экспорт данных
- Прозрачность обработки данных

### Безопасность данных

- Шифрование данных в покое (Neon)
- Шифрование данных в транзите (HTTPS)
- Регулярные бэкапы

---

**Последнее обновление:** 2025-11-09

