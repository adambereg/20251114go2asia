# План миграции Connect Asia на реальные данные

## Дата создания: 01 декабря 2025

## Текущая ситуация

### Проблема
Все страницы модуля Connect Asia показывают моковые данные, даже после подключения SDK hooks. Причины:

1. **Баланс пользователя**: API возвращает `{ points: 0, g2a: 0 }` для нового пользователя
2. **Транзакции**: Пустой массив `[]` - у пользователя нет истории транзакций
3. **Fallback на моки**: Компоненты используют моки, когда API возвращает пустые/нулевые данные
4. **Рефералы**: API может возвращать пустой массив или `null`
5. **Уровни/Достижения**: Нет API endpoints для получения этих данных

### Что работает
- ✅ SDK hooks подключены (`useGetBalance`, `useGetTransactions`, `useGetReferralStats`)
- ✅ Компоненты готовы к работе с реальными данными
- ✅ Обработка ошибок и состояний загрузки реализована

### Что не работает
- ❌ Показываются моки вместо реальных нулевых значений
- ❌ Нет начальных данных для нового пользователя
- ❌ Нет seed данных для тестирования

---

## План действий

### Этап 1: Исправить логику отображения данных (1-2 часа)

**Цель**: Показывать реальные данные из API, даже если они нулевые

#### 1.1 DashboardView
- [ ] Убрать fallback на `mockDashboardData` для баланса
- [ ] Показывать `0` вместо моковых `3500` points
- [ ] Показывать пустой список транзакций вместо моковых
- [ ] Добавить сообщение "У вас пока нет транзакций" вместо моковых данных

#### 1.2 WalletView
- [ ] Убрать fallback на `mockWalletData` для баланса
- [ ] Показывать реальные транзакции из API (даже если пусто)
- [ ] Добавить состояние "Нет транзакций"

#### 1.3 ReferralsView
- [ ] Показывать реальные данные из API
- [ ] Если `totalReferrals === 0`, показывать "0" вместо моковых "8"
- [ ] Если список рефералов пуст, показывать пустое состояние

#### 1.4 LevelsView, MissionsView, AnalyticsView
- [ ] Пока оставить моки (нет API endpoints)
- [ ] Добавить TODO комментарии о необходимости API

---

### Этап 2: Создать начальные данные для пользователя (2-3 часа)

**Цель**: При регистрации пользователя автоматически создавать начальные данные

#### 2.1 Автоматическое создание баланса
- [x] ✅ Уже реализовано в `balance.ts` - баланс создаётся автоматически при первом запросе
- [ ] Проверить, что баланс создаётся с нулевыми значениями

#### 2.2 Создать welcome транзакцию
- [ ] Добавить endpoint или логику для создания welcome транзакции при регистрации
- [ ] Тип: `points_add`, amount: `100`, reason: "Добро пожаловать в Go2Asia!"
- [ ] Вызывать при первом входе пользователя

#### 2.3 Создать начальные миссии
- [ ] Добавить endpoint для получения начальных миссий для нового пользователя
- [ ] Или создавать их автоматически при регистрации

---

### Этап 3: Seed данные для тестирования (1-2 часа)

**Цель**: Создать скрипт для заполнения БД тестовыми данными

#### 3.1 Скрипт seed данных
- [ ] Создать `scripts/seed-connect-data.ts`
- [ ] Добавить команду в `package.json`: `pnpm seed:connect`
- [ ] Скрипт должен:
  - Найти пользователя по email или userId
  - Добавить баланс (points: 3500, g2a: 125)
  - Создать 10-15 транзакций разных типов
  - Создать рефералов (если нужно)
  - Создать NFT badges (если нужно)

#### 3.2 Использование
```bash
# Заполнить данные для конкретного пользователя
pnpm seed:connect --userId=user_xxx --email=test@example.com

# Заполнить данные для всех тестовых пользователей
pnpm seed:connect --all
```

---

### Этап 4: API endpoints для недостающих данных (3-5 дней)

**Цель**: Создать API endpoints для Levels, Missions, Analytics

#### 4.1 Levels API
- [ ] `GET /v1/rewards/level` - уже существует ✅
- [ ] Подключить в `LevelsView`
- [ ] Преобразовать данные из API в формат компонента

#### 4.2 Missions API
- [ ] `GET /v1/missions` - получить список миссий пользователя
- [ ] `POST /v1/missions/{id}/start` - начать миссию
- [ ] `POST /v1/missions/{id}/complete` - завершить миссию
- [ ] Подключить в `MissionsView`

#### 4.3 Analytics API
- [ ] `GET /v1/analytics/points-chart?period=7d|30d|season` - график Points
- [ ] `GET /v1/analytics/sources` - источники наград
- [ ] `GET /v1/analytics/referral-contribution` - вклад рефералов
- [ ] `GET /v1/analytics/season-pulse` - пульс сезона
- [ ] Подключить в `AnalyticsView`

---

### Этап 5: Интеграция с другими модулями (по мере готовности)

**Цель**: Подключить реальные события из других модулей

#### 5.1 Space модуль
- [ ] При создании поста → транзакция `points_add`
- [ ] При получении лайков → транзакция `points_add`
- [ ] При завершении миссии → транзакция `points_add`

#### 5.2 Atlas модуль
- [ ] При создании гайда → транзакция `points_add`
- [ ] При одобрении редакцией → транзакция `points_add` + NFT badge

#### 5.3 Quest модуль
- [ ] При завершении квеста → транзакция `points_add`
- [ ] При достижении уровня → NFT badge

#### 5.4 RF модуль
- [ ] При оставлении отзыва → транзакция `points_add`
- [ ] При онбординге партнёра → транзакция `g2a_add`

---

## Приоритеты

### Высокий приоритет (сделать сейчас)
1. ✅ **Этап 1** - Исправить логику отображения данных
2. ✅ **Этап 2.1** - Проверить автоматическое создание баланса
3. ✅ **Этап 3** - Создать seed скрипт для тестирования

### Средний приоритет (сделать в течение недели)
4. **Этап 2.2** - Welcome транзакция
5. **Этап 4.1** - Подключить Levels API
6. **Этап 4.2** - Создать Missions API

### Низкий приоритет (сделать позже)
7. **Этап 4.3** - Создать Analytics API
8. **Этап 5** - Интеграция с другими модулями

---

## Реализация

### Шаг 1: Исправить DashboardView и WalletView

```typescript
// Было:
const balances = balanceData ? { ... } : mockDashboardData.balances;

// Стало:
const balances = balanceData !== undefined
  ? {
      points: balanceData.points || 0,
      g2a: parseFloat(String(balanceData.g2a || '0')),
      nft_count: 0,
      nft_legendary_count: 0,
    }
  : { points: 0, g2a: 0, nft_count: 0, nft_legendary_count: 0 }; // Нулевые значения вместо моков
```

### Шаг 2: Создать seed скрипт

```typescript
// scripts/seed-connect-data.ts
import { getClerkToken } from '@go2asia/sdk/clerk-integration';
import { customInstance } from '@go2asia/sdk/mutator';

async function seedConnectData(userId: string) {
  const token = await getClerkToken();
  
  // Добавить баланс
  await customInstance({
    url: '/balance/add',
    method: 'POST',
    data: { amount: 3500, reason: 'Seed data' }
  }, { headers: { Authorization: `Bearer ${token}` } });
  
  // Создать транзакции
  const transactions = [
    { amount: 100, reason: 'Добро пожаловать в Go2Asia!', type: 'points_add' },
    { amount: 200, reason: 'Гайд одобрен редакцией', type: 'points_add' },
    // ... и т.д.
  ];
  
  for (const tx of transactions) {
    await customInstance({
      url: '/balance/add',
      method: 'POST',
      data: tx
    }, { headers: { Authorization: `Bearer ${token}` } });
  }
}
```

---

## Ожидаемый результат

После выполнения плана:

1. ✅ Dashboard показывает реальный баланс (даже если `0`)
2. ✅ Wallet показывает реальные транзакции (даже если пусто)
3. ✅ Referrals показывает реальные данные (даже если `0`)
4. ✅ Есть способ заполнить тестовые данные через seed скрипт
5. ✅ Levels, Missions, Analytics подключены к API (когда готовы)

---

## Чеклист выполнения

- [ ] Этап 1: Исправить логику отображения данных
- [ ] Этап 2: Проверить создание начальных данных
- [ ] Этап 3: Создать seed скрипт
- [ ] Этап 4: Подключить API для Levels, Missions, Analytics
- [ ] Этап 5: Интеграция с другими модулями

---

## Примечания

- Моки можно оставить для разработки UI, но они не должны использоваться в production
- Seed скрипт нужен только для тестирования и разработки
- Реальные данные должны приходить из API, даже если они нулевые
- Пустые состояния должны быть информативными ("У вас пока нет транзакций" вместо моковых данных)

